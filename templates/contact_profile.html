<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ contact.name }} - Contact Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-700 to-orange-500 min-h-screen p-4">
    <div class="max-w-6xl mx-auto py-8">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden fade-in mb-6">
            <!-- Profile Header -->
            <div class="bg-gradient-to-r from-blue-600 to-orange-500 p-6">
                <div class="flex items-center justify-between">
                    <a href="/contacts" class="text-white hover:text-blue-100 transition-colors">
                        ‚Üê Back to Directory
                    </a>
                    <div class="flex gap-2">
                        {% if is_saved %}
                        <button onclick="unsaveContact({{ contact.id }})"
                                class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg transition-all text-sm">
                            ‚ùå Unsave
                        </button>
                        {% else %}
                        <button onclick="saveContact({{ contact.id }})"
                                class="bg-green-500 hover:bg-green-600 text-white font-semibold px-4 py-2 rounded-lg transition-all text-sm"
                                {% if not can_save and not (subscription and subscription.is_pro) %}disabled title="Upgrade to Pro for unlimited saves"{% endif %}>
                            üíæ Save Contact
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Contact Details -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-start gap-4 mb-6">
                    <div class="text-6xl">üë§</div>
                    <div class="flex-1">
                        <h1 class="text-3xl font-bold text-gray-900 mb-2">{{ contact.name }}</h1>

                        <div class="flex flex-wrap gap-2 mb-4">
                            {% if contact.title %}
                            <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full font-semibold">
                                üíº {{ contact.title }}
                            </span>
                            {% endif %}

                            {% if contact.company %}
                            <span class="bg-green-100 text-green-800 text-sm px-3 py-1 rounded-full font-semibold">
                                üè¢ {{ contact.company }}
                            </span>
                            {% endif %}
                        </div>

                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            {% if contact.email %}
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">‚úâÔ∏è</span>
                                <div>
                                    <div class="text-xs text-gray-600">Email</div>
                                    <a href="mailto:{{ contact.email }}" class="text-blue-600 hover:underline font-semibold">
                                        {{ contact.email }}
                                    </a>
                                </div>
                            </div>
                            {% endif %}

                            {% if contact.linkedin_url %}
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üîó</span>
                                <div>
                                    <div class="text-xs text-gray-600">LinkedIn</div>
                                    <a href="{{ contact.linkedin_url }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-semibold">
                                        View Profile
                                    </a>
                                </div>
                            </div>
                            {% endif %}

                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üì∞</span>
                                <div>
                                    <div class="text-xs text-gray-600">Mentions</div>
                                    <div class="font-bold text-gray-900">{{ contact.mention_count }} article{{ 's' if contact.mention_count != 1 else '' }}</div>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                <span class="text-2xl">
                                    {% set confidence_pct = (contact.confidence_score * 100)|int %}
                                    {% if confidence_pct >= 80 %}‚úÖ{% elif confidence_pct >= 60 %}üü°{% else %}‚ö†Ô∏è{% endif %}
                                </span>
                                <div>
                                    <div class="text-xs text-gray-600">Confidence Score</div>
                                    <div class="font-bold text-gray-900">{{ confidence_pct }}%</div>
                                </div>
                            </div>

                            {% if contact.first_mentioned_date %}
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üïê</span>
                                <div>
                                    <div class="text-xs text-gray-600">First Mentioned</div>
                                    <div class="font-semibold text-gray-900">{{ contact.first_mentioned_date[:10] }}</div>
                                </div>
                            </div>
                            {% endif %}

                            {% if contact.last_mentioned_date %}
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">üïí</span>
                                <div>
                                    <div class="text-xs text-gray-600">Last Mentioned</div>
                                    <div class="font-semibold text-gray-900">{{ contact.last_mentioned_date[:10] }}</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Aviation.Contact Sync Status -->
                {% if contact.synced_to_aviation_contact %}
                <div class="bg-green-50 border-l-4 border-green-400 p-4 rounded">
                    <div class="flex items-center gap-2">
                        <span class="text-2xl">‚úÖ</span>
                        <div>
                            <div class="font-bold text-green-900">Synced to Aviation.Contact</div>
                            <div class="text-sm text-green-700">
                                Contact ID: <span class="font-mono">{{ contact.aviation_contact_id }}</span>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üîó</span>
                            <div>
                                <div class="font-bold text-blue-900">Not yet synced to Aviation.Contact</div>
                                <div class="text-sm text-blue-700">Export this contact to your networking platform</div>
                            </div>
                        </div>
                        <button onclick="syncToAviationContact({{ contact.id }})"
                                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded-lg transition-all text-sm">
                            üîó Sync to Aviation.Contact
                        </button>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Article Mentions Timeline -->
            <div class="p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">üì∞ Article Mentions ({{ mentions|length }})</h2>

                {% if mentions %}
                <div class="space-y-4">
                    {% for mention in mentions %}
                    <div class="bg-white border-2 border-gray-200 rounded-xl p-4 hover:shadow-lg transition-shadow">
                        <div class="flex items-start gap-3 mb-3">
                            <div class="text-2xl flex-shrink-0">
                                {% if mention.sentiment_label == 'Positive' %}
                                    ‚úÖ
                                {% elif mention.sentiment_label == 'Negative' %}
                                    ‚ö†Ô∏è
                                {% else %}
                                    üì∞
                                {% endif %}
                            </div>
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-bold text-gray-900 mb-1">
                                    <a href="/catalog?id={{ mention.article_id }}" class="hover:text-blue-600 hover:underline">
                                        {{ mention.article_title }}
                                    </a>
                                </h3>

                                <div class="flex flex-wrap gap-2 text-xs mb-2">
                                    <span class="bg-{{ 'green' if mention.sentiment_label == 'Positive' else 'red' if mention.sentiment_label == 'Negative' else 'gray' }}-100 text-{{ 'green' if mention.sentiment_label == 'Positive' else 'red' if mention.sentiment_label == 'Negative' else 'gray' }}-800 px-2 py-1 rounded">
                                        {{ mention.sentiment_label or 'Neutral' }}
                                    </span>
                                    <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded">
                                        {{ mention.article_date[:10] if mention.article_date else 'Unknown date' }}
                                    </span>
                                    {% if mention.source %}
                                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded">
                                        {{ mention.source }}
                                    </span>
                                    {% endif %}
                                </div>

                                <!-- Context Snippet -->
                                {% if mention.context %}
                                <div class="bg-gray-50 border-l-4 border-gray-300 p-3 rounded mb-2">
                                    <p class="text-sm text-gray-700 italic">
                                        "{{ mention.context }}"
                                    </p>
                                </div>
                                {% endif %}

                                <!-- Title/Company at time of mention -->
                                {% if mention.title_at_time or mention.company_at_time %}
                                <div class="flex flex-wrap gap-2 text-xs">
                                    {% if mention.title_at_time %}
                                    <span class="text-gray-600">
                                        üíº Title: <strong>{{ mention.title_at_time }}</strong>
                                    </span>
                                    {% endif %}
                                    {% if mention.company_at_time %}
                                    <span class="text-gray-600">
                                        üè¢ Company: <strong>{{ mention.company_at_time }}</strong>
                                    </span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="bg-gray-50 border border-gray-200 p-8 rounded-xl text-center">
                    <div class="text-4xl mb-2">üì∞</div>
                    <p class="text-gray-600">No article mentions recorded</p>
                </div>
                {% endif %}
            </div>

            <!-- Footer Actions -->
            <div class="bg-gray-50 p-4 border-t border-gray-200 flex flex-wrap gap-4 justify-center">
                <a href="/contacts" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline">
                    ‚Üê Back to Directory
                </a>
                <a href="/contacts/saved" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline">
                    üíæ My Saved Contacts
                </a>
                {% if subscription and subscription.is_pro %}
                <button onclick="exportSingleContact('csv')" class="text-green-600 hover:text-green-800 font-semibold hover:underline">
                    üìä Export as CSV
                </button>
                <button onclick="exportSingleContact('vcard')" class="text-purple-600 hover:text-purple-800 font-semibold hover:underline">
                    üìá Export as vCard
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function saveContact(contactId) {
            const notes = prompt('Add notes for this contact (optional):');
            if (notes === null) return; // User cancelled

            fetch(`/api/contacts/${contactId}/save`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes: notes })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to save contact');
            });
        }

        function unsaveContact(contactId) {
            if (!confirm('Remove this contact from your saved collection?')) {
                return;
            }

            fetch(`/api/contacts/${contactId}/unsave`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to unsave contact');
            });
        }

        function syncToAviationContact(contactId) {
            if (!confirm('Sync this contact to Aviation.Contact platform?')) {
                return;
            }

            fetch(`/api/contacts/${contactId}/sync`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Contact synced successfully!');
                    window.location.reload();
                } else {
                    alert('Error: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to sync contact');
            });
        }

        function exportSingleContact(format) {
            window.location.href = `/api/contacts/{{ contact.id }}/export/${format}`;
        }
    </script>
</body>
</html>
